version: '3.8'

services:
  # Jaeger - All-in-one for collecting and visualizing traces
  jaeger:
    image: jaegertracing/all-in-one:latest
    ports:
      - "16686:16686"  # Jaeger UI
      - "4317:4317"    # OTLP gRPC receiver
      - "4318:4318"    # OTLP HTTP receiver
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    networks:
      - otel-network

  # API Gateway - Entry point for all requests
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    environment:
      - OTEL_SERVICE_NAME=api-gateway
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - USER_SERVICE_URL=http://user-service:8001
      - ORDER_SERVICE_URL=http://order-service:8002
    depends_on:
      - jaeger
      - user-service
      - order-service
    networks:
      - otel-network

  # User Service - Handles user operations
  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    ports:
      - "8001:8001"
    environment:
      - OTEL_SERVICE_NAME=user-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - DATABASE_SERVICE_URL=http://database-service:8003
    depends_on:
      - jaeger
      - database-service
    networks:
      - otel-network

  # Order Service - Handles order operations
  order-service:
    build:
      context: ./order-service
      dockerfile: Dockerfile
    ports:
      - "8002:8002"
    environment:
      - OTEL_SERVICE_NAME=order-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
      - DATABASE_SERVICE_URL=http://database-service:8003
      - INVENTORY_SERVICE_URL=http://inventory-service:8004
    depends_on:
      - jaeger
      - database-service
      - inventory-service
    networks:
      - otel-network

  # Database Service - Simulates database operations
  database-service:
    build:
      context: ./database-service
      dockerfile: Dockerfile
    ports:
      - "8003:8003"
    environment:
      - OTEL_SERVICE_NAME=database-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
    depends_on:
      - jaeger
    networks:
      - otel-network

  # Inventory Service - Manages inventory
  inventory-service:
    build:
      context: ./inventory-service
      dockerfile: Dockerfile
    ports:
      - "8004:8004"
    environment:
      - OTEL_SERVICE_NAME=inventory-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4317
    depends_on:
      - jaeger
    networks:
      - otel-network

networks:
  otel-network:
    driver: bridge
